{
 "Metadata": {
        "AWS::CloudFormation::Interface": {
            "ParameterGroups": [
                {
                    "Label": {
                        "default": "Instance Configuration"
                    },
                    "Parameters": [
                        "InstanceType",
                        "KeyName"
                    ]
                },
                {
                    "Label": {
                        "default": "Network Configuration"
                    },
                    "Parameters": [
                        "CreateEIP",
                        "HTTPLocation"
                    ]
                },
                {
                    "Label": {
                        "default": "VPC and Subnet"
                    },
                    "Parameters": [
                        "VpcCidr",
                        "SubnetCidr"
                    ]
                }
            ],
            "ParameterLabels": {
                "InstanceType": {
                    "default": "Instance type for Veeam Backup for AWS server"
                },
                "KeyName": {
                    "default": "Key pair for Veeam Backup for AWS server"
                },
                "CreateEIP": {
                    "default": "Create elastic IP for Veeam Backup for AWS server?"
                },
                "HTTPLocation": {
                    "default": "Allowed source IP addresses for connection to HTTPS"
                },
                "VpcCidr": {
                    "default": "VPC CIDR"
                },
                "SubnetCidr": {
                    "default": "Subnet CIDR"
                }
            }
        }
    },
    "Parameters": {
        "KeyName": {
            "Description": "Select one, or create a new one at AWS console",
            "Type": "AWS::EC2::KeyPair::KeyName",
            "ConstraintDescription": "must be the name of an existing EC2 KeyPair."
        },
        "InstanceType": {
            "Description": "",
            "Type": "String",
            "Default": "t3.medium",
            "AllowedValues": [
                "t2.medium",
                "t2.large",
                "t2.xlarge",
                "t2.2xlarge",
                "t3.medium",
                "t3.large",
                "t3.xlarge",
                "t3.2xlarge",
                "c5.large",
                "c5.2xlarge",
                "c5.4xlarge",
                "c5.9xlarge"
            ],
            "ConstraintDescription": "must be a valid EC2 instance type."
        },
        "CreateEIP": {
            "Description": "By default a dynamic IP will be created (and it could change during reboots of this instance)",
            "Default": "false",
            "Type": "String",
            "AllowedValues": [
                true,
                false
            ]
        },
        "HTTPLocation": {
            "Description": "The IP address range in CIDR format (e.g. 12.23.34.0/24) from which Veeam Backup for AWS Management portal will be accessible",
            "Type": "String",
            "MinLength": "9",
            "MaxLength": "18",
            "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
            "ConstraintDescription": "must be a valid IP CIDR range of the form x.x.x.x/x"
        },
        "VpcCidr": {
            "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
            "Default": "172.28.0.0/16",
            "Description": "Specify the IPv4 address range as a Classless Inter-Domain Routing (CIDR) block; for example, 172.28.0.0/16. You cannot specify an IPv4 CIDR block larger than /16.",
            "Type": "String"
        },
        "SubnetCidr": {
            "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
            "Default": "172.28.0.0/20",
            "Description": "Primary Public Subnet CIDR (Must be within VPC CIDR range).",
            "Type": "String"
        }
    },
    "Mappings": {
        "RegionMap": {
            "us-east-1": {
                "HVM64": "ami-0e3684ce1440e944c"
            },
            "us-gov-east-1": {
                "HVM64": "ami-0ae964892f34bc39b"
            },
            "us-gov-west-1": {
                "HVM64": "ami-07a34e5ccac5e0cb0"
            },
            "us-east-2": {
                "HVM64": "ami-0494d65a03ba42770"
            },
            "us-west-1": {
                "HVM64": "ami-0d136751414f6bf6d"
            },
            "us-west-2": {
                "HVM64": "ami-08c14f656742efba9"
            },
            "ca-central-1": {
                "HVM64": "ami-0d3e3f74ab95a37d7"
            },
            "eu-central-1": {
                "HVM64": "ami-0a9ca3989dc169286"
            },
            "eu-west-1": {
                "HVM64": "ami-080351e24e226763f"
            },
            "eu-west-2": {
                "HVM64": "ami-0a4867852ea5949b7"
            },
            "eu-west-3": {
                "HVM64": "ami-0da9f07c5e2c3fd57"
            },
            "eu-north-1": {
                "HVM64": "ami-03a3e77cb638b906f"
            },
            "eu-south-1": {
                "HVM64": "ami-0e4d41d344d862a16"
            },
            "ap-southeast-1": {
                "HVM64": "ami-0ea66d49186af8d88"
            },
            "ap-southeast-2": {
                "HVM64": "ami-05bd572125ebee64a"
            },
            "ap-southeast-3": {
                "HVM64": "ami-0b57ca7c2ac040665"
            },
            "ap-south-1": {
                "HVM64": "ami-05abc56fd2ecc7eab"
            },
            "ap-northeast-1": {
                "HVM64": "ami-09ab71d2560b838bc"
            },
            "ap-northeast-2": {
                "HVM64": "ami-00dfc62baf2b0a285"
            },
            "ap-northeast-3": {
                "HVM64": "ami-0e01535bf379a6530"
            },
            "ap-east-1": {
                "HVM64": "ami-09e3ca13d1723914c"
            },
            "sa-east-1": {
                "HVM64": "ami-07b803b7c752aed7e"
            },
            "me-south-1": {
                "HVM64": "ami-0dbf599ae0fbaf290"
            },
            "af-south-1": {
                "HVM64": "ami-0605cfc0c327bff3a"
            }
        }
    },
    "Conditions": {
        "CreateEIPCond": {
            "Fn::Equals": [
                {
                    "Ref": "CreateEIP"
                },
                "true"
            ]
        },
        "IsGovCloud": {
            "Fn::Or": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "AWS::Region"
                        },
                        "us-gov-east-1"
                    ]
                },
                {
                    "Fn::Equals": [
                        {
                            "Ref": "AWS::Region"
                        },
                        "us-gov-west-1"
                    ]
                }
            ]
        }
    },
    "Resources": {
        "VcbRebootAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmDescription": "Trigger a reboot when instance status check fails for 3 consecutive minutes.",
                "Namespace": "AWS/EC2",
                "MetricName": "StatusCheckFailed_Instance",
                "Statistic": "Minimum",
                "Period": "60",
                "EvaluationPeriods": "3",
                "ComparisonOperator": "GreaterThanThreshold",
                "Threshold": "0",
                "AlarmActions": [
                    {
                        "Fn::Join": [
                            "",
                            [
                                "arn:",
                                {
                                    "Fn::If": [
                                        "IsGovCloud",
                                        "aws-us-gov",
                                        "aws"
                                    ]
                                },
                                ":automate:",
                                {
                                    "Ref": "AWS::Region"
                                },
                                ":ec2:reboot"
                            ]
                        ]
                    }
                ],
                "Dimensions": [
                    {
                        "Name": "InstanceId",
                        "Value": {
                            "Ref": "VcbEc2Instance"
                        }
                    }
                ]
            }
        },
        "VcbRecoveryAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmDescription": "Trigger a recovery when system status check fails for 15 consecutive minutes.",
                "Namespace": "AWS/EC2",
                "MetricName": "StatusCheckFailed_System",
                "Statistic": "Minimum",
                "Period": "60",
                "EvaluationPeriods": "2",
                "ComparisonOperator": "GreaterThanThreshold",
                "Threshold": "0",
                "AlarmActions": [
                    {
                        "Fn::Join": [
                            "",
                            [
                                "arn:",
                                {
                                    "Fn::If": [
                                        "IsGovCloud",
                                        "aws-us-gov",
                                        "aws"
                                    ]
                                },
                                ":automate:",
                                {
                                    "Ref": "AWS::Region"
                                },
                                ":ec2:recover"
                            ]
                        ]
                    }
                ],
                "Dimensions": [
                    {
                        "Name": "InstanceId",
                        "Value": {
                            "Ref": "VcbEc2Instance"
                        }
                    }
                ]
            }
        },
        "VcbLifecyclePolicy": {
            "Type": "AWS::DLM::LifecyclePolicy",
            "Properties": {
                "Description": "Lifecycle Policy for a Veeam Cloud Backup instance",
                "State": "ENABLED",
                "ExecutionRoleArn": {
                    "Fn::GetAtt": [
                        "VcbSnapshotsRole",
                        "Arn"
                    ]
                },
                "PolicyDetails": {
                    "ResourceTypes": [
                        "INSTANCE"
                    ],
                    "TargetTags": [
                        {
                            "Key": "aws:cloudformation:stack-name",
                            "Value": {
                                "Ref": "AWS::StackName"
                            }
                        }
                    ],
                    "Schedules": [
                        {
                            "Name": "Vcb instance daily snapshots",
                            "TagsToAdd": [
                                {
                                    "Key": "type",
                                    "Value": "VcbDailySnapshot"
                                }
                            ],
                            "CreateRule": {
                                "Interval": 12,
                                "IntervalUnit": "HOURS",
                                "Times": [
                                    "03:00"
                                ]
                            },
                            "RetainRule": {
                                "Count": 1
                            },
                            "CopyTags": true
                        }
                    ]
                }
            }
        },
        "VcbSnapshotsRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "dlm.amazonaws.com"
                                ]
                            },
                            "Action": [
                                "sts:AssumeRole"
                            ]
                        }
                    ]
                },
                "Path": "/",
                "Policies": [
                    {
                        "PolicyName": "vcb-describe-snap",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "ec2:DescribeVolumes",
                                        "ec2:DescribeInstances",
                                        "ec2:DescribeSnapshots"
                                    ],
                                    "Resource": "*"
                                }
                            ]
                        }
                    },
                    {
                        "PolicyName": "vcb-modify-snap",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "ec2:DeleteSnapshot",
                                        "ec2:CreateTags"
                                    ],
                                    "Resource": {
                                        "Fn::Join": [
                                            "",
                                            [
                                                "arn:",
                                                {
                                                    "Fn::If": [
                                                        "IsGovCloud",
                                                        "aws-us-gov",
                                                        "aws"
                                                    ]
                                                },
                                                ":ec2:",
                                                {
                                                    "Ref": "AWS::Region"
                                                },
                                                "::snapshot/*"
                                            ]
                                        ]
                                    }
                                },
                                {
                                    "Action": [
                                        "ec2:CreateSnapshot",
                                        "ec2:CreateSnapshots"
                                    ],
                                    "Resource": "*",
                                    "Effect": "Allow"
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "VeeamInstanceBackupRestoreAccessRoleV1": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "arn:",
                                            {
                                                "Fn::If": [
                                                    "IsGovCloud",
                                                    "aws-us-gov",
                                                    "aws"
                                                ]
                                            },
                                            ":sts::",
                                            {
                                                "Ref": "AWS::AccountId"
                                            },
                                            ":role/",
                                            {
                                                "Fn::Join": [
                                                    "/",
                                                    [
                                                        {
                                                            "Ref": "VeeamImpersonationRoleV1"
                                                        }
                                                    ]
                                                ]
                                            }
                                        ]
                                    ]
                                },
                                "Service": [
                                    "backup.amazonaws.com"
                                ]
                            },
                            "Action": [
                                "sts:AssumeRole"
                            ]
                        }
                    ]
                },
                "Path": "/",
                "Policies": [
                    {
                        "PolicyName": "vcb-policy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "backup-storage:MountCapsule",
                                        "backup:CopyFromBackupVault",
                                        "backup:CopyIntoBackupVault",
                                        "backup:CreateBackupVault",
                                        "backup:DeleteBackupVault",
                                        "backup:DeleteRecoveryPoint",
                                        "backup:DescribeBackupJob",
                                        "backup:DescribeCopyJob",
                                        "backup:DescribeRecoveryPoint",
                                        "backup:DescribeRestoreJob",
                                        "backup:ListBackupVaults",
                                        "backup:ListRecoveryPointsByBackupVault",
                                        "backup:ListTags",
                                        "backup:StartBackupJob",
                                        "backup:StartCopyJob",
                                        "backup:StartRestoreJob",
                                        "backup:StopBackupJob",
                                        "backup:TagResource",
                                        "backup:UntagResource",
                                        "ebs:ListChangedBlocks",
                                        "ebs:ListSnapshotBlocks",
                                        "ec2:AcceptVpcEndpointConnections",
                                        "ec2:AllocateAddress",
                                        "ec2:AssociateAddress",
                                        "ec2:AssociateClientVpnTargetNetwork",
                                        "ec2:AssociateDhcpOptions",
                                        "ec2:AssociateRouteTable",
                                        "ec2:AssociateSubnetCidrBlock",
                                        "ec2:AssociateTransitGatewayMulticastDomain",
                                        "ec2:AssociateTransitGatewayRouteTable",
                                        "ec2:AssociateVpcCidrBlock",
                                        "ec2:AttachInternetGateway",
                                        "ec2:AttachVolume",
                                        "ec2:AttachVpnGateway",
                                        "ec2:AuthorizeClientVpnIngress",
                                        "ec2:AuthorizeSecurityGroupEgress",
                                        "ec2:AuthorizeSecurityGroupIngress",
                                        "ec2:CopySnapshot",
                                        "ec2:CreateClientVpnEndpoint",
                                        "ec2:CreateClientVpnRoute",
                                        "ec2:CreateCustomerGateway",
                                        "ec2:CreateDefaultSubnet",
                                        "ec2:CreateDefaultVpc",
                                        "ec2:CreateDhcpOptions",
                                        "ec2:CreateEgressOnlyInternetGateway",
                                        "ec2:CreateInternetGateway",
                                        "ec2:CreateKeyPair",
                                        "ec2:CreateManagedPrefixList",
                                        "ec2:CreateNatGateway",
                                        "ec2:CreateNetworkAcl",
                                        "ec2:CreateNetworkAclEntry",
                                        "ec2:CreateNetworkInterface",
                                        "ec2:CreateRoute",
                                        "ec2:CreateRouteTable",
                                        "ec2:CreateSecurityGroup",
                                        "ec2:CreateSnapshot",
                                        "ec2:CreateSnapshots",
                                        "ec2:CreateSubnet",
                                        "ec2:CreateTags",
                                        "ec2:CreateTransitGateway",
                                        "ec2:CreateTransitGatewayMulticastDomain",
                                        "ec2:CreateTransitGatewayPeeringAttachment",
                                        "ec2:CreateTransitGatewayPrefixListReference",
                                        "ec2:CreateTransitGatewayRoute",
                                        "ec2:CreateTransitGatewayRouteTable",
                                        "ec2:CreateTransitGatewayVpcAttachment",
                                        "ec2:CreateVolume",
                                        "ec2:CreateVpc",
                                        "ec2:CreateVpcEndpoint",
                                        "ec2:CreateVpcEndpointServiceConfiguration",
                                        "ec2:CreateVpcPeeringConnection",
                                        "ec2:CreateVpnConnection",
                                        "ec2:CreateVpnGateway",
                                        "ec2:DeleteClientVpnEndpoint",
                                        "ec2:DeleteClientVpnRoute",
                                        "ec2:DeleteCustomerGateway",
                                        "ec2:DeleteDhcpOptions",
                                        "ec2:DeleteEgressOnlyInternetGateway",
                                        "ec2:DeleteInternetGateway",
                                        "ec2:DeleteKeyPair",
                                        "ec2:DeleteManagedPrefixList",
                                        "ec2:DeleteNatGateway",
                                        "ec2:DeleteNetworkAcl",
                                        "ec2:DeleteNetworkAclEntry",
                                        "ec2:DeleteNetworkInterface",
                                        "ec2:DeleteRoute",
                                        "ec2:DeleteRouteTable",
                                        "ec2:DeleteSecurityGroup",
                                        "ec2:DeleteSnapshot",
                                        "ec2:DeleteSubnet",
                                        "ec2:DeleteTags",
                                        "ec2:DeleteTransitGateway",
                                        "ec2:DeleteTransitGatewayMulticastDomain",
                                        "ec2:DeleteTransitGatewayPeeringAttachment",
                                        "ec2:DeleteTransitGatewayPrefixListReference",
                                        "ec2:DeleteTransitGatewayRoute",
                                        "ec2:DeleteTransitGatewayRouteTable",
                                        "ec2:DeleteTransitGatewayVpcAttachment",
                                        "ec2:DeleteVolume",
                                        "ec2:DeleteVpc",
                                        "ec2:DeleteVpcEndpointServiceConfigurations",
                                        "ec2:DeleteVpcEndpoints",
                                        "ec2:DeleteVpcPeeringConnection",
                                        "ec2:DeleteVpnConnection",
                                        "ec2:DeleteVpnGateway",
                                        "ec2:DescribeAccountAttributes",
                                        "ec2:DescribeAddresses",
                                        "ec2:DescribeAvailabilityZones",
                                        "ec2:DescribeClientVpnAuthorizationRules",
                                        "ec2:DescribeClientVpnEndpoints",
                                        "ec2:DescribeClientVpnRoutes",
                                        "ec2:DescribeClientVpnTargetNetworks",
                                        "ec2:DescribeConversionTasks",
                                        "ec2:DescribeCustomerGateways",
                                        "ec2:DescribeDhcpOptions",
                                        "ec2:DescribeEgressOnlyInternetGateways",
                                        "ec2:DescribeImages",
                                        "ec2:DescribeInstanceAttribute",
                                        "ec2:DescribeInstanceStatus",
                                        "ec2:DescribeInstanceTypes",
                                        "ec2:DescribeInstances",
                                        "ec2:DescribeInternetGateways",
                                        "ec2:DescribeKeyPairs",
                                        "ec2:DescribeManagedPrefixLists",
                                        "ec2:DescribeNatGateways",
                                        "ec2:DescribeNetworkAcls",
                                        "ec2:DescribeNetworkInterfaceAttribute",
                                        "ec2:DescribeNetworkInterfaces",
                                        "ec2:DescribeRegions",
                                        "ec2:DescribeRouteTables",
                                        "ec2:DescribeSecurityGroups",
                                        "ec2:DescribeSnapshotAttribute",
                                        "ec2:DescribeSnapshots",
                                        "ec2:DescribeSubnets",
                                        "ec2:DescribeTags",
                                        "ec2:DescribeTransitGatewayAttachments",
                                        "ec2:DescribeTransitGatewayMulticastDomains",
                                        "ec2:DescribeTransitGatewayPeeringAttachments",
                                        "ec2:DescribeTransitGatewayRouteTables",
                                        "ec2:DescribeTransitGatewayVpcAttachments",
                                        "ec2:DescribeTransitGateways",
                                        "ec2:DescribeVolumeAttribute",
                                        "ec2:DescribeVolumes",
                                        "ec2:DescribeVpcAttribute",
                                        "ec2:DescribeVpcEndpointServiceConfigurations",
                                        "ec2:DescribeVpcEndpoints",
                                        "ec2:DescribeVpcPeeringConnections",
                                        "ec2:DescribeVpcs",
                                        "ec2:DescribeVpnConnections",
                                        "ec2:DescribeVpnGateways",
                                        "ec2:DetachInternetGateway",
                                        "ec2:DetachVolume",
                                        "ec2:DetachVpnGateway",
                                        "ec2:DisableTransitGatewayRouteTablePropagation",
                                        "ec2:DisableVgwRoutePropagation",
                                        "ec2:DisassociateAddress",
                                        "ec2:DisassociateClientVpnTargetNetwork",
                                        "ec2:DisassociateRouteTable",
                                        "ec2:DisassociateTransitGatewayMulticastDomain",
                                        "ec2:DisassociateTransitGatewayRouteTable",
                                        "ec2:EnableTransitGatewayRouteTablePropagation",
                                        "ec2:EnableVgwRoutePropagation",
                                        "ec2:GetEbsDefaultKmsKeyId",
                                        "ec2:GetManagedPrefixListEntries",
                                        "ec2:GetTransitGatewayMulticastDomainAssociations",
                                        "ec2:GetTransitGatewayPrefixListReferences",
                                        "ec2:GetTransitGatewayRouteTableAssociations",
                                        "ec2:GetTransitGatewayRouteTablePropagations",
                                        "ec2:ModifyClientVpnEndpoint",
                                        "ec2:ModifyInstanceAttribute",
                                        "ec2:ModifyManagedPrefixList",
                                        "ec2:ModifyNetworkInterfaceAttribute",
                                        "ec2:ModifySnapshotAttribute",
                                        "ec2:ModifySubnetAttribute",
                                        "ec2:ModifyTransitGateway",
                                        "ec2:ModifyTransitGatewayVpcAttachment",
                                        "ec2:ModifyVolume",
                                        "ec2:ModifyVpcAttribute",
                                        "ec2:ModifyVpcEndpoint",
                                        "ec2:ModifyVpcEndpointServiceConfiguration",
                                        "ec2:ModifyVpcPeeringConnectionOptions",
                                        "ec2:ModifyVpnConnection",
                                        "ec2:RejectVpcEndpointConnections",
                                        "ec2:ReleaseAddress",
                                        "ec2:ReplaceNetworkAclAssociation",
                                        "ec2:ReplaceRouteTableAssociation",
                                        "ec2:RevokeClientVpnIngress",
                                        "ec2:RevokeSecurityGroupEgress",
                                        "ec2:RevokeSecurityGroupIngress",
                                        "ec2:RunInstances",
                                        "ec2:SearchTransitGatewayRoutes",
                                        "ec2:StartInstances",
                                        "ec2:StopInstances",
                                        "ec2:TerminateInstances",
                                        "elasticfilesystem:Backup",
                                        "elasticfilesystem:CreateAccessPoint",
                                        "elasticfilesystem:CreateFileSystem",
                                        "elasticfilesystem:CreateMountTarget",
                                        "elasticfilesystem:DeleteAccessPoint",
                                        "elasticfilesystem:DeleteFileSystem",
                                        "elasticfilesystem:DeleteMountTarget",
                                        "elasticfilesystem:DescribeAccessPoints",
                                        "elasticfilesystem:DescribeBackupPolicy",
                                        "elasticfilesystem:DescribeFileSystemPolicy",
                                        "elasticfilesystem:DescribeFileSystems",
                                        "elasticfilesystem:DescribeLifecycleConfiguration",
                                        "elasticfilesystem:DescribeMountTargetSecurityGroups",
                                        "elasticfilesystem:DescribeMountTargets",
                                        "elasticfilesystem:DescribeTags",
                                        "elasticfilesystem:ListTagsForResource",
                                        "elasticfilesystem:PutBackupPolicy",
                                        "elasticfilesystem:PutFileSystemPolicy",
                                        "elasticfilesystem:PutLifecycleConfiguration",
                                        "elasticfilesystem:Restore",
                                        "elasticfilesystem:TagResource",
                                        "elasticfilesystem:UntagResource",
                                        "elasticfilesystem:UpdateFileSystem",
                                        "elasticloadbalancing:AddTags",
                                        "elasticloadbalancing:CreateListener",
                                        "elasticloadbalancing:CreateLoadBalancer",
                                        "elasticloadbalancing:CreateTargetGroup",
                                        "elasticloadbalancing:DeleteListener",
                                        "elasticloadbalancing:DeleteLoadBalancer",
                                        "elasticloadbalancing:DeleteTargetGroup",
                                        "elasticloadbalancing:DeregisterTargets",
                                        "elasticloadbalancing:DescribeListeners",
                                        "elasticloadbalancing:DescribeLoadBalancers",
                                        "elasticloadbalancing:DescribeTags",
                                        "elasticloadbalancing:DescribeTargetGroups",
                                        "elasticloadbalancing:DescribeTargetHealth",
                                        "elasticloadbalancing:ModifyTargetGroup",
                                        "elasticloadbalancing:RegisterTargets",
                                        "elasticloadbalancing:RemoveTags",
                                        "elasticloadbalancing:SetSecurityGroups",
                                        "elasticloadbalancing:SetSubnets",
                                        "events:DeleteRule",
                                        "events:DescribeRule",
                                        "events:ListTargetsByRule",
                                        "events:PutRule",
                                        "events:PutTargets",
                                        "events:RemoveTargets",
                                        "iam:AddRoleToInstanceProfile",
                                        "iam:AttachRolePolicy",
                                        "iam:CreateInstanceProfile",
                                        "iam:CreateRole",
                                        "iam:CreateServiceLinkedRole",
                                        "iam:DeleteInstanceProfile",
                                        "iam:DeleteRole",
                                        "iam:DeleteRolePolicy",
                                        "iam:DetachRolePolicy",
                                        "iam:GetContextKeysForPrincipalPolicy",
                                        "iam:GetInstanceProfile",
                                        "iam:GetRole",
                                        "iam:ListAccountAliases",
                                        "iam:ListAttachedRolePolicies",
                                        "iam:ListInstanceProfiles",
                                        "iam:ListInstanceProfilesForRole",
                                        "iam:ListRolePolicies",
                                        "iam:PassRole",
                                        "iam:PutRolePolicy",
                                        "iam:RemoveRoleFromInstanceProfile",
                                        "iam:SimulatePrincipalPolicy",
                                        "kinesis:CreateStream",
                                        "kinesis:DeleteStream",
                                        "kinesis:DescribeStream",
                                        "kinesis:PutRecord",
                                        "kms:CreateGrant",
                                        "kms:Decrypt",
                                        "kms:DescribeKey",
                                        "kms:Encrypt",
                                        "kms:GenerateDataKeyWithoutPlaintext",
                                        "kms:GetKeyPolicy",
                                        "kms:ListAliases",
                                        "kms:ListKeys",
                                        "kms:ReEncryptFrom",
                                        "kms:ReEncryptTo",
                                        "lambda:ListFunctions",
                                        "ram:AssociateResourceShare",
                                        "ram:CreateResourceShare",
                                        "ram:DeleteResourceShare",
                                        "ram:DisassociateResourceShare",
                                        "ram:GetResourceShareAssociations",
                                        "ram:GetResourceShares",
                                        "ram:ListPrincipals",
                                        "ram:ListResourceSharePermissions",
                                        "ram:ListResources",
                                        "ram:TagResource",
                                        "ram:UntagResource",
                                        "rds:AddTagsToResource",
                                        "rds:CopyDbClusterSnapshot",
                                        "rds:CopyDBSnapshot",
                                        "rds:CreateDBClusterSnapshot",
                                        "rds:CreateDBInstance",
                                        "rds:CreateDBSnapshot",
                                        "rds:DeleteDBCluster",
                                        "rds:DeleteDbclusterSnapshot",
                                        "rds:DeleteDBInstance",
                                        "rds:DeleteDBSnapshot",
                                        "rds:DescribeAccountAttributes",
                                        "rds:DescribeDBClusterParameterGroups",
                                        "rds:DescribeDBClusterParameters",
                                        "rds:DescribeDBClusters",
                                        "rds:DescribeDBClusterSnapshots",
                                        "rds:DescribeDBEngineVersions",
                                        "rds:DescribeDBInstances",
                                        "rds:DescribeDBParameterGroups",
                                        "rds:DescribeDBSnapshots",
                                        "rds:DescribeDBSubnetGroups",
                                        "rds:DescribeOptionGroups",
                                        "rds:DescribeOrderableDBInstanceOptions",
                                        "rds:ListTagsForResource",
                                        "rds:ModifyDBCluster",
                                        "rds:ModifyDBClusterSnapshotAttribute",
                                        "rds:ModifyDBInstance",
                                        "rds:ModifyDBSnapshotAttribute",
                                        "rds:RemoveTagsFromResource",
                                        "rds:RestoreDBClusterFromSnapshot",
                                        "rds:RestoreDBInstanceFromDBSnapshot",
                                        "s3:DeleteObject",
                                        "s3:GetBucketLocation",
                                        "s3:GetObject",
                                        "s3:ListAllMyBuckets",
                                        "s3:ListBucket",
                                        "s3:PutObject",
                                        "s3:RestoreObject",
                                        "servicequotas:ListServiceQuotas",
                                        "sns:CreateTopic",
                                        "sns:DeleteTopic",
                                        "sns:ListSubscriptionsByTopic",
                                        "sns:ListTopics",
                                        "sns:SetTopicAttributes",
                                        "sns:Subscribe",
                                        "sns:Unsubscribe",
                                        "sqs:CreateQueue",
                                        "sqs:DeleteMessage",
                                        "sqs:DeleteQueue",
                                        "sqs:ListQueues",
                                        "sqs:ReceiveMessage",
                                        "sqs:SendMessage",
                                        "sqs:SetQueueAttributes",
                                        "ssm:DescribeInstanceInformation",
                                        "ssm:GetCommandInvocation",
                                        "ssm:GetParameter",
                                        "ssm:SendCommand"
                                    ],
                                    "Resource": "*"
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "VeeamImpersonationRoleV1": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "ec2.amazonaws.com"
                                ]
                            },
                            "Action": [
                                "sts:AssumeRole"
                            ]
                        }
                    ]
                },
                "Path": "/",
                "Policies": [
                    {
                        "PolicyName": "vcb-assume",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "sts:AssumeRole"
                                    ],
                                    "Resource": "*"
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "VcbInstanceProfile": {
            "Type": "AWS::IAM::InstanceProfile",
            "Properties": {
                "Path": "/",
                "Roles": [
                    {
                        "Ref": "VeeamImpersonationRoleV1"
                    }
                ]
            }
        },
        "VcbEc2Instance": {
            "Type": "AWS::EC2::Instance",
            "Properties": {
                "InstanceType": {
                    "Ref": "InstanceType"
                },
                "IamInstanceProfile": {
                    "Ref": "VcbInstanceProfile"
                },
                "SecurityGroupIds": [
                    {
                        "Ref": "VcbSecurityGroup"
                    }
                ],
                "KeyName": {
                    "Ref": "KeyName"
                },
                "ImageId": {
                    "Fn::FindInMap": [
                        "RegionMap",
                        {
                            "Ref": "AWS::Region"
                        },
                        "HVM64"
                    ]
                },
                "SubnetId": {
                    "Ref": "VcbSubnet"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Ref": "AWS::StackName"
                        }
                    }
                ],
                "BlockDeviceMappings": [
                    {
                        "DeviceName": "/dev/sda1",
                        "Ebs": {
                            "VolumeSize": "16"
                        }
                    }
                ],
                "UserData": {
                    "Fn::Base64": {
                        "Fn::Join": [
                            "\n",
                            [
                                {
                                    "Fn::GetAtt": [
                                        "VeeamImpersonationRoleV1",
                                        "Arn"
                                    ]
                                },
                                {
                                    "Fn::GetAtt": [
                                        "VeeamInstanceBackupRestoreAccessRoleV1",
                                        "Arn"
                                    ]
                                }
                            ]
                        ]
                    }
                }
            }
        },
        "VcbEIP": {
            "Type": "AWS::EC2::EIP",
            "Condition": "CreateEIPCond",
            "Properties": {
                "Domain": "vpc"
            }
        },
        "VcbEIPAssociation": {
            "Type": "AWS::EC2::EIPAssociation",
            "Condition": "CreateEIPCond",
            "Properties": {
                "AllocationId": {
                    "Fn::GetAtt": [
                        "VcbEIP",
                        "AllocationId"
                    ]
                },
                "InstanceId": {
                    "Ref": "VcbEc2Instance"
                }
            }
        },
        "VcbSubnet": {
            "Properties": {
                "CidrBlock": {
                    "Ref": "SubnetCidr"
                },
                "MapPublicIpOnLaunch": "true",
                "VpcId": {
                    "Ref": "VcbVPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Join": [
                                " ",
                                [
                                    {
                                        "Ref": "AWS::StackName"
                                    },
                                    "Subnet"
                                ]
                            ]
                        }
                    }
                ]
            },
            "Type": "AWS::EC2::Subnet"
        },
        "VcbVPC": {
            "Properties": {
                "CidrBlock": {
                    "Ref": "VpcCidr"
                },
                "EnableDnsSupport": "true",
                "EnableDnsHostnames": "true",
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Join": [
                                " ",
                                [
                                    {
                                        "Ref": "AWS::StackName"
                                    },
                                    "VPC"
                                ]
                            ]
                        }
                    }
                ]
            },
            "Type": "AWS::EC2::VPC"
        },
        "VcbInternetGateway": {
            "Type": "AWS::EC2::InternetGateway",
            "Properties": {
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Join": [
                                " ",
                                [
                                    {
                                        "Ref": "AWS::StackName"
                                    },
                                    "InternetGateway"
                                ]
                            ]
                        }
                    }
                ]
            }
        },
        "VcbGatewayAttachment": {
            "Type": "AWS::EC2::VPCGatewayAttachment",
            "Properties": {
                "VpcId": {
                    "Ref": "VcbVPC"
                },
                "InternetGatewayId": {
                    "Ref": "VcbInternetGateway"
                }
            }
        },
        "VcbRouteTable": {
            "Properties": {
                "VpcId": {
                    "Ref": "VcbVPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Join": [
                                " ",
                                [
                                    {
                                        "Ref": "AWS::StackName"
                                    },
                                    "RouteTable"
                                ]
                            ]
                        }
                    }
                ]
            },
            "Type": "AWS::EC2::RouteTable"
        },
        "VcbRouteToGateway": {
            "Type": "AWS::EC2::Route",
            "DependsOn": "VcbGatewayAttachment",
            "Properties": {
                "DestinationCidrBlock": "0.0.0.0/0",
                "RouteTableId": {
                    "Ref": "VcbRouteTable"
                },
                "GatewayId": {
                    "Ref": "VcbInternetGateway"
                }
            }
        },
        "VcbRouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "RouteTableId": {
                    "Ref": "VcbRouteTable"
                },
                "SubnetId": {
                    "Ref": "VcbSubnet"
                }
            }
        },
        "VcbS3Endpoint": {
            "Type": "AWS::EC2::VPCEndpoint",
            "Properties": {
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": "*",
                            "Action": "*",
                            "Resource": "*"
                        }
                    ]
                },
                "RouteTableIds": [
                    {
                        "Ref": "VcbRouteTable"
                    }
                ],
                "ServiceName": {
                    "Fn::Sub": "com.amazonaws.${AWS::Region}.s3"
                },
                "VpcId": {
                    "Ref": "VcbVPC"
                }
            }
        },
        "VcbSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "Enable HTTPS access via ports 443",
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "443",
                        "ToPort": "443",
                        "CidrIp": {
                            "Ref": "HTTPLocation"
                        }
                    }
                ],
                "VpcId": {
                    "Ref": "VcbVPC"
                }
            }
        }
    },
    "Outputs": {
        "InstanceId": {
            "Description": "InstanceId of the newly created Vcb EC2 instance",
            "Value": {
                "Ref": "VcbEc2Instance"
            }
        }
    }
}
